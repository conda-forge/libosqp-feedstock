{% set version = "1.0.0" %}
{% set qdldlversion = "0.1.8" %}

package:
  name: libosqp
  version: {{ version }}

source:
  url: https://github.com/osqp/osqp/archive/refs/tags/v{{ version }}.tar.gz
  sha256: dd6a1c2e7e921485697d5e7cdeeb043c712526c395b3700601f51d472a7d8e48
  patches:
    # use libqdldl from conda-forge, build interface in osqp directly
    # - patches/0002-build-qdldl-interface-as-part-of-osqp.patch
      # install osqp_demo and osqp_tester executables to easily make them relocatable,
      # see: https://github.com/conda-forge/libosqp-feedstock/pull/12#discussion_r1807117589
    - patches/0001-Install-osqp_demo-and-osqp_tester.patch

build:
  number: 0
  run_exports:
    # No ABI policy is documented, let's be conservative
    - {{ pin_subpackage('libosqp', max_pin='x.x.x') }}
  ignore_run_exports:
    - numpy

requirements:
  build:
    - {{ compiler('c') }}
    - {{ compiler('cxx') }}
    - {{ stdlib('c') }}
    - cmake
    - ninja
    # Unittest source code is generated at build time using numpy and scipy
    - python
    - numpy
    - scipy
  host:
    - libqdldl ={{ qdldlversion }}

test:
  commands:
    - test -f ${PREFIX}/include/osqp/osqp.h  # [not win]
    - test -f ${PREFIX}/lib/libosqp.so  # [linux]
    - test -f ${PREFIX}/lib/libosqp.dylib  # [osx]
    - test -f ${PREFIX}/lib/cmake/osqp/osqp-config.cmake  # [not win]
    - if not exist %LIBRARY_INC%\osqp\osqp.h exit 1                     # [win]
    - if not exist %LIBRARY_LIB%\osqp.lib exit 1                        # [win]
    - if not exist %LIBRARY_BIN%\osqp.dll exit 1                        # [win]
    - if not exist %LIBRARY_LIB%\cmake\osqp\osqp-config.cmake exit 1    # [win]
    - osqp_demo
    - osqp_tester

about:
  home: https://github.com/osqp/osqp
  license: Apache-2.0
  summary: The Operator Splitting QP Solver.
  license_file:
    - LICENSE
    - lin_sys/direct/qdldl/amd/LICENSE

extra:
  recipe-maintainers:
    - traversaro
    - h-vetinari
